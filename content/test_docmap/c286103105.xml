<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE concept PUBLIC "-//OASIS//DTD DITA Concept//EN" "concept.dtd">
				<concept CreatedForRelease="CMM22" status="deleted" id="concept_k4k_wjc_jtb"><title>SGSN support for Kafka removal for charging (Feature f14203-04)</title><shortdesc>This feature implements the SGSN Kafka removal for charging        purposes.</shortdesc><prolog><author>PEIPEI SHANG</author></prolog><conbody><p>The SGSN charging no longer uses the Kafka for the CDR transfer or for any other            charging purposes. The Kafka removal for charging is implemented for both the CNF and            the VNF models.</p><p>The SGSN generates the CDRs when a predefined event (for example, the PDP context            deactivation) occurs.</p><p>In previous releases, the charging processes in the PAPS published the CDRs in            Kafka pipe. The charging process in active NECC is fetching the CDRs from the Kafka pipe            and according to the configuration (Bp/Ga interface), the CDRs were written in the DAT            file inside the charging folder or transferred to the charging gateways through the GTP            interface.</p><p>By removing the Kafka implementation, a buffer mechanism is introduced to the            S4-SGSN. Especially one buffer, a ring queue, that holds a super-packet per CGW. The            super-packet contains up to 60 CDRs, with default value 30 CDRs. The S4-SGSN has three            indexes for the queue:</p><ul><li>The last inserted index in the queue</li><li>The delivery ack index, which is the first not-committed index</li><li>The last consumed index packet</li></ul><p>After each PAPS receives an internal message containing a CDR, the PAPS S4-SGSN            stores the CDR in a bundled packet containing up to 60 CDRs. When a new bundled packet            is created, the S4-SGSN inserts it in the queue. The packet index is the last inserted            index. The S4-SGSN checks the delivery ack index. If the index is the previous one, the            S4-SGSN sends the packet to charging module in the NECC and starts the supervision            delivery timer. If the delivery ack index is smaller than the previous one of the last            inserted indexes, it does not send the packet, that means a delivery ack is pending.            Upon receiving a delivery ack, the S4-SGSN increases the delivery ack index and checks            the last inserted index to see if there is pending packet to be sent. The S4-SGSN also            cancels the supervision of delivery ack timer. If the delivery ack timer expires, the            S4-SGSN retransmits the last sent packet. The charging module in the NECC receives the            message from the charging module in the PAPS and acknowledges the transaction.</p><section>            <title>Example:</title>            <p>Last inserted index: 0, deliver index: 0, consumed: 0</p>            <p>S4-SGSN adds 2 CDR bundles in Queue.</p>            <table><title>CDR bundles</title><tgroup cols="6"><colspec colname="c1" colnum="1"/><colspec colname="c2" colnum="2"/><colspec colname="c3" colnum="3"/><colspec colname="c4" colnum="4"/><colspec colname="c5" colnum="5"/><colspec colname="c6" colnum="6"/><tbody><row><entry>CDR bundle 1</entry><entry>CDR bundle 2</entry><entry/><entry/><entry/><entry/></row></tbody></tgroup></table>            <p>Last inserted index: 2, deliver ack: 0, consumed: 0</p>            <p>The S4-SGSN sends a message to the SGSN charging gateway function                (CGF) because delivery ack index is smaller than the last inserted index.</p>            <p>Last inserted index: 2, deliver ack: 1, consumed: 0</p>            <p>Delivery ack = 1 and consumed index = 0. The SgsnA4S does not send                any more messages to the CGF.</p>            <p>The CGF receives the message and respond with delivery ack index.</p>            <p>Last inserted index: 2, deliver index: 1, consumed: 1</p>            <p>The S4-SGSN is now able to send the CDR bundle 2 to the CGF.</p>            <p>If the Bp interface is active, the CGF writes those CDRs to its                internal memory and when that buffer reaches the maximum DAT file size of 10 MB, a                DAT file is created. When the CGF writes those CDRs in the internal buffer, a new                message is sent to the S4-SGSN notifying that the CDRs are consumed. A timer (120                seconds) in the CGF must be introduced in case that the CDR flow from the S4-SGSN is                low and the 10 MB of DAT file cannot be reached. The buffer is written in the DAT                file.</p>            <p>If the Ga interface is active, the CGF transfers those CDRs to the                SGSN intelligent gateway (GIG). The GIG sends those CDRs to the corresponding CGW                and send a message to the CGF. The CGF sends that message to the S4-SGSN notifying                that those CDRs are consumed successfully.</p>            <p>Each message from the S4-SGSN contains the index of the super-packet                in the queue. That index is sent back from the CGF and the GIG to synchronize the                consumption. The CGF has a structure map&lt;papsId, Map&lt;CGWid, index of last                consumed&gt;&gt;, in which the CGF stores the index per charging gateway per                PAPS.</p>            <p>When the NECC restarts/reboots, the CGF in startup phase receives                message from the GIG. A new message to all PAPS is implemented that the charging in                the NECC is up and running. The CGF on startup sends message to the S4-SGSN                notifying that it is ready. The S4-SGSN resets the delivery ack index and retransmit                the CDR bundles.</p>            <p>Inside that message, the CGF sends the indexes per CGW. Also, the                delivery timer in the S4-SGSN expires and resents that CDR bundle.</p>            <p>When the PAPS restarts/reboots, the NECC-based charging part keeps                processing any local buffered CDR bundles and commit them when finished as well.                After the PAPS restart is ended, the PAPS sends a message to the NECC notifying that                the S4-SGSN is working and will close forcibly all previously open CDRs owned by                that PAPS after retrieving them first from the DBS and before processing any                traffic.</p>            <p>The NECC needs to send the delivery ack index of the last received                message that the NECC handled towards the PAPS. The PAPS initializes the ring queue                based on that index. The commits that will come and are before that last received                index, which will be the new tail of the queue, will be ignored by the S4-SGSN.</p>            <p>In the S4-SGSN, in the startup phase, a new message sent to the CGF                is implemented that the S4-SGSN is up and running.</p>        </section></conbody></concept>